# MCPサーバーのHTTPサーバー実装計画（チケット #6）

## 概要

既存のstdioベースのMCPサーバーをHTTPベースのサービスに変換し、チームコラボレーションとリモートアクセスを可能にする。

## 実装手順

### 1. HTTPサーバー実装の作成

- **ファイル**: `src/mcp/http_server.py`
- モダンな非同期HTTP APIのためにFastAPIフレームワークを使用
- 認証ミドルウェア（JWTトークン）の実装
- WebクライアントのためのCORSサポートを追加
- MCPツールをミラーリングするRESTfulエンドポイントの作成：
  - POST `/api/query` - 技術文書のクエリ
  - POST `/api/documents` - 単一文書の追加
  - POST `/api/documents/batch` - 複数文書の追加
  - GET `/api/documents` - 文書一覧の取得
  - GET `/api/system/info` - システム情報の取得
  - DELETE `/api/database` - データベースのクリア
  - GET `/api/health` - ヘルスチェックエンドポイント

### 2. 認証とセキュリティ

- **ファイル**: `src/mcp/auth.py`
- JWTベースの認証を実装
- サービス間通信のためのAPIキーサポートを追加
- ユーザー/APIキーごとのレート制限
- 入力検証とサニタイゼーション
- 本番環境でのHTTPS強制

### 3. 依存関係の更新

- **ファイル**: `pyproject.toml`
- FastAPIと関連依存関係を追加：
  - `fastapi>=0.100.0`
  - `uvicorn>=0.23.0`
  - `python-jose[cryptography]>=3.3.0`
  - `passlib[bcrypt]>=1.7.4`
  - `python-multipart>=0.0.6`

### 4. 設定

- **ファイル**: `config/http_server_config.yaml`
- サーバー設定（ホスト、ポート、ワーカー数）
- 認証設定
- CORS許可オリジン
- レート制限ルール
- TLS/SSL設定

### 5. クライアントSDK

- **ファイル**: `src/mcp/http_client.py`
- 簡単な統合のためのPythonクライアントライブラリ
- 認証の自動処理
- 堅牢性のためのリトライロジック
- 使用例のドキュメント

### 6. テスト

- **ファイル**: `tests/unit/test_http_server.py`
- すべてのエンドポイントのテスト
- 認証フローのテスト
- エラーハンドリングのテスト
- レート制限のテスト

- **ファイル**: `tests/integration/test_http_integration.py`
- 実際のRAGエンジンを使用したエンドツーエンドテスト
- マルチユーザーシナリオ
- パフォーマンステスト

### 7. ドキュメント

- **ファイル**: `docs/HTTP_SERVER_README.md`
- 例を含むAPIドキュメント
- 認証ガイド
- デプロイメント手順
- セキュリティベストプラクティス

### 8. デプロイメントサポート

- **ファイル**: `Dockerfile.http`
- HTTPサーバー用のDockerコンテナ
- 環境変数設定
- ヘルスチェックサポート

- **ファイル**: `docker-compose.http.yml`
- 完全なデプロイメントスタック
- リバースプロキシ（nginx）を含む
- データベース永続化

### 9. 移行パス

- 既存のMCP stdioサーバーを維持
- HTTPサーバーを追加インターフェースとして提供
- ユーザー向けの移行プロセスを文書化

## セキュリティ考慮事項

- すべてのエンドポイントで認証が必要（ヘルスチェックを除く）
- すべてのユーザー入力に対する入力検証
- SQLインジェクション防止（パラメータ化クエリ）
- パストラバーサル保護
- 悪用防止のためのレート制限
- すべての操作の監査ログ

## テスト戦略

1. 各エンドポイントの単体テスト
2. 実際のPDF処理を使用した統合テスト
3. セキュリティテスト（認証バイパス試行、インジェクションテスト）
4. パフォーマンステスト（同時ユーザー、大容量ファイル）
5. セキュリティ監査のためのgemini-review

## メリット

- 認証付きマルチユーザーアクセス
- 簡単な統合のためのRESTful API
- Web UI の可能性
- ロードバランシング機能
- より良いモニタリングとメトリクス
- チームコラボレーション機能

## 実装の優先順位

1. 基本的なHTTPサーバーとエンドポイント
2. 認証とセキュリティ
3. テストスイート
4. ドキュメント
5. Dockerサポート
6. クライアントSDK

---

**注意**: このガイドラインはマークダウンのlintエラーを修正し、適切なマークダウン形式に従っています。
